name: CI

on:
  pull_request:
  push:
    branches: [main]

env:
  FLUTTER_VERSION: 3.41.1

jobs:
  lint:
    name: Analyze & format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      - run: flutter pub get
      - run: flutter analyze
      - run: dart format --output=none --set-exit-if-changed lib/ test/

  test:
    name: Unit & widget tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      - run: flutter pub get
      - run: flutter test --coverage

  build-android:
    name: Build Android (universal APK)
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      - run: flutter pub get
      # flutter build apk produces a fat/universal APK containing arm64-v8a,
      # armeabi-v7a, and x86_64 slices in a single file.
      - run: flutter build apk --release

  build-macos-silicon:
    name: Build macOS (Apple Silicon)
    runs-on: macos-latest
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      - name: Ensure macOS desktop project
        run: |
          flutter config --enable-macos-desktop
          if [[ ! -d macos/Runner.xcodeproj ]]; then
            flutter create --platforms=macos .
          fi
          flutter pub get
          if [[ ! -d macos/Runner.xcworkspace ]]; then
            (cd macos && pod install)
          fi
          test -d macos/Runner.xcodeproj
          test -d macos/Runner.xcworkspace
      - run: flutter build macos --release
      - uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-bin
          path: build/macos/Build/Products/Release/zen_journal.app/Contents/MacOS/zen_journal

  build-macos-intel:
    name: Build macOS (Intel)
    runs-on: macos-15-intel
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      - name: Ensure macOS desktop project
        run: |
          flutter config --enable-macos-desktop
          if [[ ! -d macos/Runner.xcodeproj ]]; then
            flutter create --platforms=macos .
          fi
          flutter pub get
          if [[ ! -d macos/Runner.xcworkspace ]]; then
            (cd macos && pod install)
          fi
          test -d macos/Runner.xcodeproj
          test -d macos/Runner.xcworkspace
      - run: flutter build macos --release
      - uses: actions/upload-artifact@v4
        with:
          name: macos-x86_64-bin
          path: build/macos/Build/Products/Release/zen_journal.app/Contents/MacOS/zen_journal

  build-ios:
    name: Build iOS (no-codesign)
    runs-on: macos-latest
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      - run: flutter pub get
      - run: flutter build ios --release --no-codesign

  build-windows:
    name: Build Windows (x64)
    runs-on: windows-latest
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      - run: flutter pub get
      - run: flutter build windows --release
      - name: Validate release output path
        shell: pwsh
        run: |
          if (!(Test-Path "build\windows\x64\runner\Release\*")) {
            throw "Expected build\windows\x64\runner\Release\* to exist."
          }

  build-windows-arm64:
    name: Build Windows (arm64)
    runs-on: windows-11-arm
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v4
      - name: Setup Flutter (arm64 fallback)
        shell: pwsh
        run: |
          git clone --depth 1 --branch "${env:FLUTTER_VERSION}" https://github.com/flutter/flutter.git "$env:USERPROFILE\flutter"
          "$env:USERPROFILE\flutter\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
      - run: flutter --version
      - run: flutter pub get
      - run: flutter build windows --release
      - name: Validate release output path
        shell: pwsh
        run: |
          $armPath = "build\windows\arm64\runner\Release\*"
          $x64Path = "build\windows\x64\runner\Release\*"
          if (!(Test-Path $armPath) -and !(Test-Path $x64Path)) {
            throw "Windows ARM runner did not produce arm64 or x64 release output."
          }

  build-linux-x64:
    name: Build Linux (x64)
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v4
      - run: sudo apt-get update -y && sudo apt-get install -y ninja-build libgtk-3-dev libsecret-1-dev dpkg-dev rpm
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true
      - run: flutter pub get
      - run: flutter build linux --release
      - run: chmod +x scripts/package-linux.sh && ./scripts/package-linux.sh x64 "0.0.0-ci"

  build-linux-arm64:
    name: Build Linux (arm64)
    runs-on: ubuntu-22.04-arm
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v4
      - run: sudo apt-get update -y && sudo apt-get install -y ninja-build libgtk-3-dev libsecret-1-dev dpkg-dev rpm
      - name: Setup Flutter (arm64 fallback)
        run: |
          git clone --depth 1 --branch "${FLUTTER_VERSION}" https://github.com/flutter/flutter.git "${HOME}/flutter"
          echo "${HOME}/flutter/bin" >> "${GITHUB_PATH}"
      - run: flutter --version
      - run: flutter pub get
      - run: flutter build linux --release
      - run: chmod +x scripts/package-linux.sh && ./scripts/package-linux.sh arm64 "0.0.0-ci"
